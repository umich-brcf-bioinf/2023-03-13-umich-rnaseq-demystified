---
title: "... Exercise 1 - Independent Exercise - Customize a PCA plot"
author: "UM Bioinformatics Core"
date: "`r Sys.Date()`"
output:
        html_document:
            includes:
                in_header: header.html
            theme: paper
            toc: true
            toc_depth: 4
            toc_float: true
            number_sections: false
            fig_caption: true
            markdown: GFM
            code_download: true
---

<style type="text/css">
body, td {
   font-size: 18px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 12px
}
</style>

```{r, include = FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("09a-")
```

```{r Modules, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(DESeq2)
library(ggplot2)
library(tidyr)
library(dplyr)
library(matrixStats)
library(ggrepel)
library(pheatmap)
library(RColorBrewer)
# load("rdata/RunningData.RData")
```

Estimated time: **15 Minutes**


# Motivation

Plotting the expression values across all samples for the top variable genes in an experiment can help to visualize how samples cluster together by their expression profiles. When combined with phenotypic data, it can help show how samples with different treatments behave relative to one another.

# Exercise

Try doing the following to the `pca_plot`, starting with the "most popular" request and moving on to other customizations if you have time:

* Add a title and subtitle to the plot using the `labs()` function.
* Add labels to show which samples correspond to which points, like [here](https://support.bioconductor.org/p/90791/) and/or [apply more general recommendations from this R graph gallery](https://r-graph-gallery.com/275-add-text-labels-with-ggplot2.html)
* Make our color palette color-blind friendly (with `RColorBrewer`), like [here](https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/) and/or [here](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)
* Use shape instead of color to indicate groups on the PCA plot. Hint, since color and shape are both mapping aspects, so we'll need to re-specify shape instead of color (instead of adding an additional layers like the other prompts), similar to [these R graph gallery examples](https://r-graph-gallery.com/274-map-a-variable-to-ggplot2-scatterplot.html) 
* _Challenge_: Change the legend title to "Iron Status". Hint, you can do this with the `labs()` function too, using the corresponding aesthetic mapping (e.g. "color").

# Instructions

- Work independently in the main room, posting any questions that arise to slack.
- Join a room with a helper for a more guided experience.
- We'll review possible solutions when 

# Example

To get an idea of what we expect to see at the end, let's look at a toy example from the `pheatmap()` help examples. There's no need to run this code, we just want to illustrate the form of the result.

```{r test_heatmap}
# Copied from the pheatmap documentation

# Create matrix with random normally distributed values
test = matrix(rnorm(200), 20, 10)

# Impose some structure so the heatmap appears interesting
test[1:10, seq(1, 10, 2)] = test[1:10, seq(1, 10, 2)] + 3
test[11:20, seq(2, 10, 2)] = test[11:20, seq(2, 10, 2)] + 2
test[15:20, seq(2, 10, 2)] = test[15:20, seq(2, 10, 2)] + 4

# Name the rows and columns
colnames(test) = paste("Test", 1:10, sep = "")
rownames(test) = paste("Gene", 1:20, sep = "")

# Draw the heatmap
pheatmap(test)
```

# Steps

1. Look at the documentation for the `pheatmap()` function and determine what the most important parameter is. Hint: It's usually the first or first few parameters. This is telling us what we'll have to get for the next step.

<details>
<summary>Answer</summary>
```{r pheatmap_help, eval = FALSE}
?pheatmap
```

For this exercise, we'll only need to use the `mat` parameter, giving the numeric matrix to be plotted.
</details>
<br>

2. Extract the rlog normalized expression values for the experiment. Hint: We created an `rld` object earlier. The `assay()` function pulls out the values.

<details>
<summary>Answer</summary>
```{r extract_rld_expression}
exp_mat = assay(rld)
head(exp_mat)
```
</details>
<br>

3. Calculate the variance for each gene in the expression matrix we just extracted. Hint: Look at the help for `matrixStats::rowVars()` and decide if that's a reasonable function to use.

<details>
<summary>Answer</summary>
```{r calc_row_vars}
gene_vars = rowVars(exp_mat)
head(gene_vars)
```
</details>
<br>

4. Get the numerical indices for the top 50 most variable genes. Hint: Run the `order()` function on a toy example, like `order(c(-1.25, 1.3, 5.6, 2.1))`, and think about what is being returned. Note, it's not the values in the original vector. Then look at the help for `order()` and figure out how how to reverse what is returned.

<details>
<summary>Answer</summary>
```{r order_vars}
order(c(-1.25, 1.3, 5.6, 2.1))
order(c(-1.25, 1.3, 5.6, 2.1), decreasing = TRUE)

ordered_idx = order(gene_vars, decreasing = TRUE)
top_50_idx = ordered_idx[1:50]
```
</details>
<br>

5. Subset the expression matrix from step 2 using this index vector. Hint: Remember square-bracket notation, and that we want to subset the rows, while returning all the columns. Make sure the result has the number of rows you expect, that is, 50.

<details>
<summary>Answer</summary>
```{r extract_top_exp}
top_var_exp_mat = exp_mat[top_50_idx, ]
dim(top_var_exp_mat)
```
</details>
<br>

6. Create a heatmap using this subsetted expression matrix using the `pheatmap()` function.

<details>
<summary>Answer</summary>
```{r create_heatmap}
pheatmap(top_var_exp_mat)
```
</details>
<br>

# Saving the result

If time permits, discuss with your group how you might save this heatmap. Hint: Look at the parameters for the function in `?pheatmap`. Alternatively, consider how we saved the PCA in the previous module.

```{r WriteOut.RData, eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
#Hidden code block to write out data for knitting
# save.image(file = "rdata/RunningData.RData")
```
